{% extends "base.html" %}
{# This template is used for both editing and adding pages #}

{% block extrahead %}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/admin_shells.css" />
    <script type="text/javascript" src="{{STATIC_URL}}js/tiny_mce/tiny_mce.js"></script>
    <script src="{{ STATIC_URL}}js/jquery/jquery.tablednd_0_5.js" type="text/javascript"></script>

{% endblock %}

{% block content %}



<div id="content" class="grid_8">

{# Re-usable include for status messages #}
{% include 'inlines/messages.html' %}



{% if page %}
    <h2>Editing Page "{{page}}"</h2>
{% else %}
    <h2>Creating new page in shell "{{shell}}"</h2>
{% endif %}



<input id="shell_return" class="button" type="submit" value="Return to shell editor" style="margin:20px 0px;width:600px;" />


<form class="pageform" enctype="multipart/form-data" action="" method="post" accept-charset="utf-8">
	{% csrf_token %}


    <p>
        <label>{{form.title.label}}</label>
        {{form.title}}
        <span class="help_text">{{form.title.help_text|safe}}</span>
    </p>

    <p>
        <label>{{form.body.label}}</label>
        {{form.body}}<br />
        <span class="help_text">{{form.body.help_text|safe}}</span>
    </p>


    <fieldset id="pagemedia" class="" style="margin-top:-30px;width:520px;">
        <legend>Media for this page {% if page.media_set.all.count > 0 %}- click to edit{% endif %}</legend>
		{% if page.id %}
        <div class="medialist">
        {% for m in page.media_set.all  %}
        &raquo; <a href="{% url shells_admin_edit_media m.id %}">{{m}}</a><br />
        {% endfor %}
        </div>

		<p class="fakebutton" style="margin-top:20px;"><a href="{% url shells_admin_new_media page.id %}">Add new media</a></p>
        <p style="margin-bottom:-10px;">To insert media objects into your page, use: <br />{% templatetag openvariable %} media 23 {% templatetag closevariable %}<br /> (substituting the actual media ID you want to appear).</p>

		{% else %}
		<p>You must save this page before you can add media to it.</p>
		{% endif %}
    </fieldset>


    <fieldset id="pagewidgets" class="" style="width:520px;">
        <legend>Widgets for page sidebar {% if page.widget_set.all.count > 0 %}- click to edit, drag to order{% endif %}</legend>
		{% if page.id %}


        <table id="widgettable">
            {% for w in page.widget_set.all  %}
            <tr id="{{ w.id }}" class="{% cycle 'even' 'odd' %}" >
                <td class="dragHandle showDragHandle">&nbsp;</td>
                <td>
                    <h3 style="padding-left:20px;">
                        <a href="{% url shells_admin_edit_widget w.id %}">
                        {{w.title}}</a>
                    </h3>
                </td>
            </tr>
            {% endfor %}
        </table>

		<p class="fakebutton" style="margin-top:20px;"><a href="{% url shells_admin_new_widget page.id %}">Add new widget</a></p>
        <p style="margin-bottom:-10px;">If this page is the homepage, widgets will appear <br />automatically at the bottom of the sidebar.</p>

		{% else %}
		<p>You must save this page before you can add widgets to it.</p>
		{% endif %}
    </fieldset>



    <p>
        <label>{{form.icon.label}}</label>
        <span class="help_text">{{form.icon.help_text|safe}} </span><br />
        {{form.icon}}<br />

         {% if page.icon %}
            <a href="{{MEDIA_URL}}{{page.icon}}"><img src="{{MEDIA_URL}}{{page.icon}}"  /></a>
            {% else %}
            <img src="{{STATIC_URL}}images/question.png" width="75" height="75">
        {% endif %}

    </p>


    <p>
        <label>{{form.icon_alt.label}}</label>
        <span class="help_text">{{form.icon_alt.help_text|safe}} </span><br />
        {{form.icon_alt}}<br />

         {% if page.icon_alt %}
            <a href="{{MEDIA_URL}}{{page.icon_alt}}"><img src="{{MEDIA_URL}}{{page.icon_alt}}"  /></a>
            {% else %}
            <img src="{{STATIC_URL}}images/question.png" width="75" height="75">
        {% endif %}

    </p>

    <p>
        <label>{{form.disable_icon.label}}</label>
        {{form.disable_icon}}
        <span class="help_text">{{form.disable_icon.help_text|safe}}</span>
    </p>

    <p>
        <label>{{form.shownavlabel.label}}</label>
        {{form.shownavlabel}}
        <span class="help_text">{{form.shownavlabel.help_text|safe}}</span>
    </p>

    <input class="button blue" type="submit" value="Save" style="margin-top:10px;" />


</form>

{% if page %}
    <p class="alert" style="margin-left:20px;"><a href="javascript:confirmDelete('{% url admin_delete_page page.id %}')">&#x2326; Delete this page</a></p>
{% endif %}

</div>




<script type="text/javascript" charset="utf-8">

// Get confirmation before deleting story
function confirmDelete(delUrl) {
  if (confirm("Are you sure you want to delete this page?")) {
    document.location = delUrl;
  }
}


function order_widgets(data) {
    // The JQuery plugin tableDnD provides a serialize() function which provides the re-ordered
    // data in a list. We pass that list as an object called "data" to a Django view
    // to save the re-ordered data into the database.

    $.post("{% url shells_reorder_widgets %}", data, "json");
    return False;
};

$(document).ready(function(){

    {# Can't reverse URL back to shell page if creating a new page since we don't yet have a page object. #}
    {% if page %}
        $("#shell_return").click(function() {
            window.location.href = '{% url shells_admin_shell page.shell.slug %}';
        });
    {% else %}
        $("#shell_return").click(function() {
            window.location.href = '{% url shells_admin_shell shell.slug %}';
        });
    {% endif %}


    // Initialise the task table for drag/drop re-ordering
    $("#widgettable").tableDnD();

    $('#widgettable').tableDnD({
        onDrop: function(table, row) {
            order_widgets($.tableDnD.serialize());
        },
        dragHandle: "dragHandle"
    });

});
</script>



{% endblock %}

